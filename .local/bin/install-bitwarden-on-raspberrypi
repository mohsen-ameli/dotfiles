#/bin/bash
# This script shows how to install vaultwarden (bitwarden alternative) on raspberry pi (mine was version 3B+)
# Bitwarden's own script won't work since the pi is ARM based and bitwarden only works with x86-64 rip ;(
# Make sure you have a domain name for this specific instructions to work. If doing this locally i'm not sure how to do it.
# This article was usefull. https://raspberrytips.com/install-bitwarden-on-raspberry-pi/ 
# At the end of the installation we have to do a little extra work documenated there.
# Change YOUR_DOMAIN before running

sudo su
apt update && apt upgrade -y

# install docker
apt install ca-certificates curl
install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/raspbian/gpg -o /etc/apt/keyrings/docker.asc
chmod a+r /etc/apt/keyrings/docker.asc
echo   "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/raspbian \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
apt update
apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
docker run hello-world

# install certbot for HTTPS SSL
apt install python3 python3-dev python3-venv libaugeas-dev gcc
python3 -m venv /opt/certbot/
/opt/certbot/bin/pip install --upgrade pip
/opt/certbot/bin/pip install certbot certbot-nginx
ln -s /opt/certbot/bin/certbot /usr/bin/certbot

certbot certonly -d YOUR_DOMAIN.com

# move the keys generated by certbot to /ssl/keys to use with docker container
mkdir /ssl
mkdir /ssl/keys
cp /etc/letsencrypt/live/YOUR_DOMAIN.com/fullchain.pem /ssl/keys/certs.pem
cp /etc/letsencrypt/live/YOUR_DOMAIN.com/privkey.pem /ssl/keys/key.pem

docker run --name vaultwarden -d -e SIGNUPS_ALLOWED=true -e ROCKET_TLS='{certs="/ssl/certs.pem",key="/ssl/key.pem"}' -v /ssl/keys/:/ssl/ -v /vw-data/:/data/ -p 443:80 vaultwarden/server:latest

# Now go to YOUR_DOMAIN.com and register for an account. Then run the following lines
#docker stop vaultwarden
#docker rm vaultwarden
#docker run --name vaultwarden -d -e SIGNUPS_ALLOWED=false \
#-e ROCKET_TLS='{certs="/ssl/certs.pem",key="/ssl/key.pem"}' \
#-v /ssl/keys/:/ssl/ -v /vw-data/:/data/ -p 443:80 vaultwarden/server:latest

